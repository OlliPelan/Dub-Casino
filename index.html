<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Casino Lobby</title>
  <style>
    html, body { margin: 0; padding: 0; background: #000; height: 100%; overscroll-behavior: none; touch-action: none; }
    * { -webkit-tap-highlight-color: transparent; -webkit-user-select: none; user-select: none; }
    #game-root { position: fixed; inset: 0; display: grid; place-items: center; background: #000; overflow: hidden; }
    canvas { image-rendering: pixelated; image-rendering: crisp-edges; width: 100vw; height: 100vh; max-width: 100%; max-height: 100%; display: block; background: #1a0f1a; cursor: pointer; }

    .dialog { position: fixed; left: 50%; top: 50%; transform: translate(-50%,-50%); background: rgba(16,8,16,0.95); border: 1px solid #caa86a; color: #f1e8d0; padding: 10px 12px; width: min(80vw, 260px); border-radius: 8px; box-shadow: 0 8px 26px rgba(0,0,0,0.5); display: none; z-index: 10; pointer-events: auto; }
    .dialog h4 { margin: 0 0 6px 0; font: 700 15px/1.25 system-ui, sans-serif; color: #ffd56b; }
    .dialog p { margin: 0 0 10px 0; font: 12px/1.35 system-ui, sans-serif; opacity: 0.9; }
    .start-overlay { padding-top: 60px; position: fixed; inset: 0; background: url('dc.png') center/cover no-repeat; display: grid; place-items: center; z-index: 9; }
    .start-overlay button { background: #ffd56b; border: none; border-radius: 12px; padding: 16px 18px; color: #3a2b10; font: 800 16px/1 system-ui, sans-serif; cursor: pointer; }

    .quit-btn {
      position: fixed;
      left: 1rem;
      bottom: 1rem;
      padding: 0.75rem 1.25rem;
      font-size: 1rem;
      border: none;
      border-radius: 20rem;
      background-color: rgba(255, 77, 77, 0.9);
      color: rgb(255, 255, 255);
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000;
      font-weight: bold;
    }

    .mute-btn {
      position: fixed;
      right: 1rem;
      bottom: 1rem;
      padding: 0.75rem;
      font-size: 1.2rem;
      border: none;
      border-radius: 50%;
      background-color: rgba(255, 215, 0, 0.9);
      color: rgb(0, 0, 0);
      cursor: button;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @media (max-width: 600px) {
      .quit-btn { font-size: 0.9rem; padding: 0.6rem 1rem; right: 0.75rem; top: 1rem; }
      .mute-btn { width: 45px; height: 45px; font-size: 1rem; }
    }
  </style>
</head>
<body>
  <div id="game-root">
    <canvas id="game" role="application" aria-label="Game lobby"></canvas>
  </div>

  <div id="startOverlay" class="start-overlay">
    <button id="startBtn">Tap to Start</button>
  </div>

  <button id="quitBtn" class="quit-btn" style="display:none;">Quit</button>
  <button id="muteBtn" class="mute-btn" style="display:none;">ðŸ”Š</button>

<script>
(function(){
 'use strict';
 const ASSETS = {
   background: 'https://cdn.abacus.ai/images/ba393218-5d4c-4d90-a7e1-64870ec7fbfc.png',
   pages: {
     blackjack: 'blackjack.html',
     poker: 'poker.html',
     slots: 'slotmachine.html',
     solitaire: 'solitaire.html'
   },
   music: {
     lobby: ['07 - Imagooo feat. Kimmovuohenkasvattamakoira (Remix) (1).mp3', 'Dollarit dub.mp3'],
     blackjack: 'Sivistynyt dub.mp3',
     poker: 'Terve dub.mp3',
     slots: 'Dollarit dub.mp3',
     solitaire: '10 - (Pelastakaa) Koisotie (Remix).mp3'
   }
 };

 // disable some gestures at root
 ['gesturestart','gesturechange','gestureend','dblclick'].forEach(t => {
   document.addEventListener(t, e => e.preventDefault(), { passive:false });
 });

 const canvas = document.getElementById('game');
 const ctx = canvas.getContext('2d');

 function resizeCanvas() {
   const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
   const w = Math.floor(window.innerWidth);
   const h = Math.floor(window.innerHeight);
   canvas.width = w * dpr;
   canvas.height = h * dpr;
   canvas.style.width = w + 'px';
   canvas.style.height = h + 'px';
   ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
 }
 window.addEventListener('resize', resizeCanvas);
 resizeCanvas();

 const world = { width: 768, height: 1365 };

 const zones = [
   { id: 'blackjack', label: 'Blackjack', x: world.width/2 - 190, y: 150, w: 380, h: 200 },
   { id: 'poker', label: 'Poker', x: 30, y: 610, w: 280, h: 190 },
   { id: 'slots', label: 'Slots', x: world.width - 310, y: 610, w: 280, h: 180 },
   { id: 'solitaire', label: 'Solitaire', x: world.width/2 - 170, y: world.height - 270, w: 340, h: 170 }
 ];

 let currentAudio = null;
 let lobbyTrackIndex = 0;

 function playMusic(trackOrTracks) {
   if (currentAudio) {
     try { currentAudio.pause(); } catch(e) {}
     currentAudio = null;
   }

   let track;
   if (Array.isArray(trackOrTracks)) {
     track = trackOrTracks[lobbyTrackIndex % trackOrTracks.length];
   } else {
     track = trackOrTracks;
   }

   const isMuted = localStorage.getItem('casinoMusicMuted') === 'true';
   currentAudio = new Audio(track);
   currentAudio.loop = false;
   currentAudio.volume = isMuted ? 0 : 0.7;

   currentAudio.addEventListener('ended', () => {
     if (Array.isArray(trackOrTracks)) {
       lobbyTrackIndex++;
       playMusic(trackOrTracks);
     } else {
       currentAudio.currentTime = 0;
       currentAudio.play();
     }
   });

   currentAudio.play().catch(err => console.log('Audio play failed:', err));
}

function worldPointFromClient(x, y){
  const rect = canvas.getBoundingClientRect();
  const clickX = x - rect.left;
  const clickY = y - rect.top;
  const vp = getViewport();
  const worldX = (clickX - vp.offX) / vp.scale;
  const worldY = (clickY - vp.offY) / vp.scale;
  return { worldX, worldY };
}

// ----------------- GAME SELECT (lobby) -----------------
// Start the selected game's music inside this user gesture before navigating.
canvas.addEventListener('click', (e) => {
  if (!started) return;
  const { worldX, worldY } = worldPointFromClient(e.clientX, e.clientY);
  const clickedZone = zones.find(z => worldX >= z.x && worldX <= z.x + z.w && worldY >= z.y && worldY <= z.y + z.h);
  if (clickedZone) {
    const gameMusic = ASSETS.music[clickedZone.id];
    const url = ASSETS.pages[clickedZone.id];

    if (gameMusic) {
      if (currentAudio) { try { currentAudio.pause(); } catch(e){} currentAudio = null; }
      currentAudio = new Audio(gameMusic);
      currentAudio.loop = true;
      const isMuted = localStorage.getItem('casinoMusicMuted') === 'true';
      currentAudio.volume = isMuted ? 0 : 0.7;
      currentAudio.play().catch(err => console.warn('Game audio start failed:', err));
      localStorage.setItem('casinoGameMusic', gameMusic);
    }

    if (url) setTimeout(() => { window.location.href = url; }, 180);
  }
});

canvas.addEventListener('touchstart', (e) => {
  if (e.target !== canvas || !started) return;
  e.preventDefault();
  const t = e.touches[0];
  const { worldX, worldY } = worldPointFromClient(t.clientX, t.clientY);
  const clickedZone = zones.find(z => worldX >= z.x && worldX <= z.x + z.w && worldY >= z.y && worldY <= z.y + z.h);
  if (clickedZone) {
    const gameMusic = ASSETS.music[clickedZone.id];
    const url = ASSETS.pages[clickedZone.id];

    if (gameMusic) {
      if (currentAudio) { try { currentAudio.pause(); } catch(e){} currentAudio = null; }
      currentAudio = new Audio(gameMusic);
      currentAudio.loop = true;
      const isMuted = localStorage.getItem('casinoMusicMuted') === 'true';
      currentAudio.volume = isMuted ? 0 : 0.7;
      currentAudio.play().catch(err => console.warn('Game audio start failed:', err));
      localStorage.setItem('casinoGameMusic', gameMusic);
    }

    if (url) setTimeout(() => { window.location.href = url; }, 180);
  }
});

const startOverlay = document.getElementById('startOverlay');
const startBtn = document.getElementById('startBtn');
const quitBtn = document.getElementById('quitBtn');
const muteBtn = document.getElementById('muteBtn');
let started = false;

// Initialize mute button state
const initiallyMuted = localStorage.getItem('casinoMusicMuted') === 'true';
if (muteBtn) {
  muteBtn.textContent = initiallyMuted ? 'ðŸ”‡' : 'ðŸ”Š';
  // click + touch
  muteBtn.addEventListener('click', toggleMute);
  muteBtn.addEventListener('touchstart', function(e){ e.preventDefault(); toggleMute(); }, { passive: false });
}

startBtn.addEventListener('click', () => {
  started = true;
  startOverlay.style.display = 'none';
  quitBtn.style.display = 'block';
  muteBtn.style.display = 'flex';
  playMusic(ASSETS.music.lobby);
});

function quitToStart() {
  // Stop any playing audio and show start overlay (index should show overlay by default)
  if (currentAudio) { try { currentAudio.pause(); } catch(e){} currentAudio = null; }
  localStorage.removeItem('casinoGameMusic');
  setTimeout(() => { window.location.href = 'index.html'; }, 80);
}

function toggleMute() {
  const isMuted = localStorage.getItem('casinoMusicMuted') === 'true';
  const newMutedState = !isMuted;
  localStorage.setItem('casinoMusicMuted', newMutedState);

  const mBtn = document.getElementById('muteBtn');
  if (mBtn) mBtn.textContent = newMutedState ? 'ðŸ”‡' : 'ðŸ”Š';

  if (currentAudio) currentAudio.volume = newMutedState ? 0 : 0.7;
}

quitBtn.addEventListener('click', quitToStart);

// Background image for canvas rendering
const bgImg = new Image();
bgImg.crossOrigin = 'anonymous';
bgImg.onerror = () => console.log('bg load error â€” gradient fallback');
bgImg.src = ASSETS.background;

function getViewport() {
  const vw = canvas.width / (window.devicePixelRatio || 1);
  const vh = canvas.height / (window.devicePixelRatio || 1);
  const scale = Math.min(vw / world.width, vh / world.height);
  const viewW = world.width * scale;
  const viewH = world.height * scale;
  const offX = (vw - viewW) / 2;
  const offY = (vh - viewH) / 2;
  return { scale, offX, offY, vw, vh, viewW, viewH };
}

function drawBackground(vp) {
  if (bgImg.complete && bgImg.naturalWidth > 0) {
    ctx.imageSmoothingEnabled = false;
    ctx.drawImage(bgImg, vp.offX, vp.offY, vp.viewW, vp.viewH);
  } else {
    const g = ctx.createLinearGradient(0,0,0,canvas.height);
    g.addColorStop(0, '#2b1730');
    g.addColorStop(1, '#1a0f1a');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,canvas.width, canvas.height);
  }
}

function render(dt) {
  const vp = getViewport();
  ctx.clearRect(0,0,canvas.width, canvas.height);
  drawBackground(vp);

  // subtle zone outlines intentionally left out (no glow)
  ctx.save();
  ctx.globalAlpha = 0.05;
  ctx.fillStyle = '#000';
  zones.forEach(z => {
    const x = vp.offX + z.x * vp.scale;
    const y = vp.offY + z.y * vp.scale;
    const w = z.w * vp.scale;
    const h = z.h * vp.scale;
    // optional: faint stroke to hint zones (very subtle)
    ctx.strokeStyle = 'rgba(255,215,0,0.03)';
    ctx.lineWidth = 2;
    ctx.strokeRect(x, y, w, h);
  });
  ctx.restore();
}

let last = performance.now();
function loop(now) {
  const dt = Math.min(48, now - last); last = now;
  if (started) { render(dt); }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
})();
</script>

</body>
</html>